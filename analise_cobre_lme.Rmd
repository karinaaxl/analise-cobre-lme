---
title: "Análise dos Preços do Cobre — LME"
subtitle: "Cotações Cash Seller | Janeiro 2020 – Dezembro 2025"
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    code_folding: hide
    fig_width: 10
    fig_height: 6
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo       = TRUE,
  message    = FALSE,
  warning    = FALSE,
  fig.align  = "center",
  fig.path   = "graficos/"
)
```

```{r pacotes, include=FALSE}
pacotes <- c("readxl", "dplyr", "tidyr", "lubridate", "ggplot2",
             "scales", "stringr", "purrr", "knitr", "kableExtra", "openxlsx")
novos <- pacotes[!(pacotes %in% installed.packages()[, "Package"])]
if (length(novos)) install.packages(novos, repos = "https://cran.r-project.org")

library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(scales)
library(stringr)
library(purrr)
library(knitr)
library(kableExtra)
library(openxlsx)

theme_set(theme_minimal(base_size = 13) +
            theme(plot.title       = element_text(face = "bold", size = 15),
                  plot.subtitle    = element_text(color = "grey40"),
                  panel.grid.minor = element_blank()))
```

# Introdução

Este relatório apresenta a análise das cotações à vista (*Cash Seller*) do cobre
negociado na **London Metal Exchange (LME)**, com dados diários de **02/01/2020 a
31/12/2025**.

Todo o processamento — da consolidação à geração de gráficos — foi realizado em
**R (v4.5.1)**, utilizando os pacotes `readxl`, `dplyr`, `lubridate`, `ggplot2` e
auxiliares. O código completo e reproduzível encontra-se no **Anexo** ao final deste
documento.


# Consolidação dos Dados

As 72 planilhas foram lidas e empilhadas. De cada arquivo,
extraiu-se a aba *Copper*, selecionando a coluna de data e o preço *Cash Seller*
(USD/tonelada). Datas em formato serial do Excel foram convertidas para o padrão
`Date` do R.

```{r consolidacao, include=FALSE}
caminho_dados <- file.path(
  "C:/Users/karin/OneDrive/Área de Trabalho/TESTE4i",
  "Dados/lme_prices (1)/prices"
)

arquivos <- list.files(caminho_dados, pattern = "\\.xlsx$", full.names = TRUE)

ler_planilha <- function(caminho) {
  nome_arquivo <- basename(caminho)
  raw <- read_excel(caminho, sheet = "Copper",
                    col_names = FALSE, col_types = "text")
  # Col 1 = Data (serial) | Col 3 = Cash SELLER | Col 17 = SETTLEMENT
  dados <- raw |>
    slice(7:n()) |>
    select(data_serial = 1, cash_seller = 3, settlement = 17) |>
    mutate(data_serial = as.numeric(data_serial),
           cash_seller = as.numeric(cash_seller),
           settlement  = as.numeric(settlement),
           arquivo     = nome_arquivo) |>
    filter(!is.na(data_serial)) |>
    mutate(data = as.Date(data_serial, origin = "1899-12-30")) |>
    select(data, cash_seller, settlement, arquivo)
  return(dados)
}

cobre_raw <- map_dfr(arquivos, ler_planilha)
```

**Validações realizadas:**

```{r validacoes}
diff_cs   <- sum(abs(cobre_raw$cash_seller - cobre_raw$settlement) > 0.01)
n_dups    <- cobre_raw |> group_by(data) |> filter(n() > 1) |> nrow()
n_nas     <- sum(is.na(cobre_raw$cash_seller))

cobertura <- cobre_raw |>
  mutate(ano_mes = floor_date(data, "month")) |>
  group_by(ano_mes) |>
  summarise(n_dias = n(), .groups = "drop")

tibble(
  `Verificação` = c("Cash Seller = Settlement",
                     "Datas duplicadas",
                     "Valores ausentes (NA)",
                     "Meses cobertos",
                     "Intervalo"),
  Resultado     = c(paste0(diff_cs, " divergências"),
                     paste0(n_dups, " duplicatas"),
                     paste0(n_nas, " NAs"),
                     paste0(nrow(cobertura), " meses (cobertura completa)"),
                     paste(as.character(min(cobre_raw$data)), "a",
                           as.character(max(cobre_raw$data))))
) |>
  kable() |>
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = FALSE)
```

```{r serie_final, include=FALSE}
cobre <- cobre_raw |>
  distinct(data, .keep_all = TRUE) |>
  arrange(data) |>
  select(data, preco = cash_seller)

write.csv(cobre, "output/cobre_cash_seller_2020_2025.csv", row.names = FALSE)
```

A série consolidada contém **`r nrow(cobre)` observações** (dias úteis), de
`r format(min(cobre$data), "%d/%m/%Y")` a `r format(max(cobre$data), "%d/%m/%Y")`.


# Resultados

## 1. Menor cotação do período

```{r q1}
minimo <- cobre |> slice_min(preco, n = 1)
```

O cobre atingiu sua menor cotação em **`r format(minimo$data, "%d/%m/%Y")`**, ao preço
de **USD `r format(minimo$preco, big.mark = ".", decimal.mark = ",")`/t**.

## 2. Maior cotação do período

```{r q2}
maximo <- cobre |> slice_max(preco, n = 1)
```

A maior cotação foi registrada em **`r format(maximo$data, "%d/%m/%Y")`**, quando
o metal alcançou **USD `r format(maximo$preco, big.mark = ".", decimal.mark = ",")`/t**.

## 3. Variação média mensal — 2020 e 2024

```{r q3}
ultimo_mes <- cobre |>
  mutate(ano_mes = floor_date(data, "month")) |>
  group_by(ano_mes) |>
  slice_max(data, n = 1) |>
  ungroup() |>
  arrange(ano_mes) |>
  mutate(var_mensal_pct = (preco / lag(preco) - 1) * 100,
         ano = year(ano_mes))

var_2020 <- ultimo_mes |> filter(ano == 2020, !is.na(var_mensal_pct))
var_2024 <- ultimo_mes |> filter(ano == 2024, !is.na(var_mensal_pct))

media_2020 <- mean(var_2020$var_mensal_pct)
media_2024 <- mean(var_2024$var_mensal_pct)

bind_rows(
  var_2020 |> mutate(periodo = "2020"),
  var_2024 |> mutate(periodo = "2024")
) |>
  select(periodo, ano_mes, preco, var_mensal_pct) |>
  mutate(ano_mes        = format(ano_mes, "%Y-%m"),
         preco          = round(preco, 2),
         var_mensal_pct = round(var_mensal_pct, 2)) |>
  kable(col.names = c("Ano", "Mês", "Preço (USD/t)", "Var. mensal (%)"),
        caption = "Variações mensais — 2020 e 2024") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  pack_rows("2020", 1, nrow(var_2020)) |>
  pack_rows("2024", nrow(var_2020) + 1, nrow(var_2020) + nrow(var_2024))
```

| Ano  | Variação média mensal |
|------|-----------------------|
| 2020 | **`r format(round(media_2020, 2), decimal.mark = ",")`%** |
| 2024 | **`r format(round(media_2024, 2), decimal.mark = ",")`%** |

## 4. Variação acumulada (02/01/2020 a 31/12/2025)

```{r q4}
preco_inicio  <- cobre |> filter(data >= as.Date("2020-01-02")) |> slice_min(data, n = 1)
preco_fim     <- cobre |> filter(data <= as.Date("2025-12-31")) |> slice_max(data, n = 1)
var_acumulada <- (preco_fim$preco / preco_inicio$preco - 1) * 100
```

| Referência | Data | Preço (USD/t) |
|---|---|---|
| Início | `r format(preco_inicio$data, "%d/%m/%Y")` | `r format(preco_inicio$preco, big.mark = ".", decimal.mark = ",")` |
| Fim | `r format(preco_fim$data, "%d/%m/%Y")` | `r format(preco_fim$preco, big.mark = ".", decimal.mark = ",")` |

**Variação acumulada no período: `r format(round(var_acumulada, 2), decimal.mark = ",")`%**

## 5. Média mensal dos preços

```{r q5_grafico_media_mensal, fig.width=12, fig.height=6}
media_mensal <- cobre |>
  mutate(ano_mes = floor_date(data, "month")) |>
  group_by(ano_mes) |>
  summarise(preco_medio = mean(preco, na.rm = TRUE), .groups = "drop")

ggplot(media_mensal, aes(x = ano_mes, y = preco_medio)) +
  geom_line(color = "#B87333", linewidth = 1) +
  geom_point(color = "#B87333", size = 1.5) +
  geom_smooth(method = "loess", se = TRUE, alpha = 0.15,
              color = "steelblue", linewidth = 0.7) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = label_comma(big.mark = ".", decimal.mark = ",")) +
  labs(title    = "Preço Médio Mensal do Cobre (Cash Seller)",
       subtitle = "LME — Janeiro 2020 a Dezembro 2025",
       x = NULL, y = "USD / Tonelada",
       caption  = "Fonte: London Metal Exchange (LME)") +
  annotate("rect", xmin = as.Date("2020-03-01"), xmax = as.Date("2020-06-01"),
           ymin = -Inf, ymax = Inf, alpha = 0.1, fill = "red") +
  annotate("text", x = as.Date("2020-04-15"),
           y = max(media_mensal$preco_medio) * 0.95,
           label = "COVID-19", size = 3, color = "red")

ggsave("graficos/media_mensal_cobre.png", width = 12, height = 6, dpi = 300)
```

## 6. Cotação trimestral (último dia do trimestre)

```{r q6_grafico_trimestral, fig.width=12, fig.height=6}
trimestral <- cobre |>
  mutate(trimestre = floor_date(data, "quarter")) |>
  group_by(trimestre) |>
  slice_max(data, n = 1) |>
  ungroup() |>
  arrange(data) |>
  mutate(label_trim = paste0(year(data), " T", quarter(data)))

ggplot(trimestral, aes(x = data, y = preco)) +
  geom_col(fill = "#B87333", alpha = 0.8, width = 60) +
  geom_text(aes(label = format(round(preco, 0), big.mark = ".")),
            vjust = -0.5, size = 3) +
  scale_x_date(breaks = trimestral$data, labels = trimestral$label_trim) +
  scale_y_continuous(labels = label_comma(big.mark = ".", decimal.mark = ","),
                     expand = expansion(mult = c(0, 0.12))) +
  labs(title    = "Cotação do Cobre no Último Dia de Cada Trimestre",
       subtitle = "LME Cash Seller — 2020 a 2025",
       x = NULL, y = "USD / Tonelada",
       caption  = "Fonte: London Metal Exchange (LME)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))

ggsave("graficos/cotacao_trimestral_cobre.png", width = 12, height = 6, dpi = 300)
```

## 7. Variação anual

```{r q7_grafico_variacao_anual, fig.width=10, fig.height=6}
anual <- cobre |>
  mutate(ano = year(data)) |>
  group_by(ano) |>
  summarise(primeiro = preco[which.min(data)],
            ultimo   = preco[which.max(data)],
            data_ult = max(data), .groups = "drop") |>
  mutate(var_anual_pct = (ultimo / primeiro - 1) * 100)

ggplot(anual, aes(x = factor(ano), y = var_anual_pct,
                   fill = var_anual_pct > 0)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = paste0(format(round(var_anual_pct, 1),
                                       decimal.mark = ","), "%")),
            vjust = ifelse(anual$var_anual_pct > 0, -0.5, 1.5),
            size = 4, fontface = "bold") +
  scale_fill_manual(values = c("TRUE" = "#2E8B57", "FALSE" = "#CD5C5C")) +
  scale_y_continuous(labels = label_comma(decimal.mark = ",", suffix = "%"),
                     expand = expansion(mult = c(0.15, 0.15))) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  labs(title    = "Variação Anual do Preço do Cobre (Cash Seller)",
       subtitle = "LME — 2020 a 2025 | Primeiro vs. último dia útil do ano",
       x = NULL, y = "Variação (%)",
       caption  = "Fonte: London Metal Exchange (LME)")

ggsave("graficos/variacao_anual_cobre.png", width = 10, height = 6, dpi = 300)
```

```{r q7_tabela}
anual |>
  mutate(data_ult       = format(data_ult, "%d/%m/%Y"),
         primeiro       = round(primeiro, 2),
         ultimo         = round(ultimo, 2),
         var_anual_pct  = paste0(format(round(var_anual_pct, 2),
                                        decimal.mark = ","), "%")) |>
  kable(col.names = c("Ano", "Preço inicial", "Preço final",
                       "Último dia útil", "Var. anual (%)"),
        caption = "Variação anual do cobre") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 8. Determinantes da trajetória observada

**2020 — Choque pandêmico e recuperação em V.** O cobre abriu o ano próximo de
USD 6.165/t e sofreu queda acentuada entre março e abril com a paralisação
industrial causada pela COVID-19, atingindo o vale da série. Estímulos fiscais e
monetários coordenados globalmente, somados à retomada acelerada da China
(responsável por mais de 50% do consumo mundial de cobre), conduziram uma
recuperação expressiva no segundo semestre, fechando o ano com alta de ~26%.

**2021 — Rally das commodities.** Gargalos nas cadeias de suprimento, restrições
de oferta em minas no Chile e Peru e o fortalecimento da narrativa de transição
energética (veículos elétricos, energia renovável) impulsionaram o cobre a
máximas históricas no período, com alta de ~25% no ano.

**2022 — Correção sob aperto monetário.** O ciclo de alta de juros liderado pelo
Federal Reserve, o fortalecimento do dólar e os lockdowns prolongados na China
("COVID zero") pressionaram os preços para baixo. A crise do setor imobiliário
chinês (Evergrande) contribuiu para a retração de ~14% no ano.

**2023 — Estabilização.** O mercado acomodou-se em faixa intermediária, digerindo
a perspectiva de fim do aperto monetário. A reabertura chinesa ficou aquém das
expectativas, mas restrições de oferta (queda na produção do Panamá, problemas
operacionais no Peru) sustentaram um piso para os preços, com variação próxima
de zero no ano.

**2024 — Retomada gradual.** A expectativa de cortes de juros pelo Fed e a
aceleração de investimentos em eletrificação (EVs, redes elétricas, data centers
para IA) reacenderam o interesse pelo metal. Fundos especulativos ampliaram
posições compradas, refletindo a tese do "superciclo" do cobre.

**2025 — Máximas históricas.** A demanda ligada à transição energética e à
expansão de infraestrutura de IA elevou o cobre a patamares recordes, com alta
acumulada de ~44% no ano. Tensões comerciais (tarifas EUA–China) e restrições
de oferta minerária mantiveram os preços elevados com volatilidade pontual.

**Síntese.** A trajetória do cobre entre 2020 e 2025 reflete sua transição de
commodity cíclica para ativo estratégico. O descompasso estrutural entre demanda
crescente (eletrificação, data centers, EVs) e oferta limitada (escassez de novos
projetos minerários, grades decrescentes) sustenta a tendência de longo prazo,
moderada por ciclos de política monetária e pela dinâmica da economia chinesa.

# Como replicar esta análise {.unnumbered}

1. Coloque as planilhas `.xlsx` da LME na pasta `Dados/lme_prices (1)/prices/`.
2. Abra o arquivo `analise_cobre_lme.Rmd` no RStudio.
3. Execute os *chunks* sequencialmente (`Ctrl+Alt+R`) ou selecione trechos individuais.

Para incluir novos meses, basta adicionar os arquivos ao diretório e reexecutar.
O código detecta automaticamente todos os `.xlsx` presentes.


# Exportação da planilha de verificação {.unnumbered}

```{r exportar_excel, include=FALSE}
# ---- Aba 1: Série histórica ----
serie <- cobre |>
  mutate(data = format(data, "%d/%m/%Y")) |>
  rename(Data = data, `Cash Seller (USD/t)` = preco)

# ---- Aba 2: Verificação ----
# Montar tabela com os preços de fechamento mensal para verificar via fórmulas
verif_mensal <- cobre |>
  mutate(ano_mes = floor_date(data, "month")) |>
  group_by(ano_mes) |>
  slice_max(data, n = 1) |>
  ungroup() |>
  arrange(ano_mes) |>
  select(ano_mes, data, preco) |>
  mutate(ano_mes = format(ano_mes, "%Y-%m"),
         data    = format(data, "%d/%m/%Y"))

wb <- createWorkbook()

# Aba 1
addWorksheet(wb, "Serie_Historica")
writeData(wb, "Serie_Historica", serie)

# Aba 2 - Verificacao
addWorksheet(wb, "Verificacao")

# Cabeçalho das instruções
writeData(wb, "Verificacao", "VERIFICAÇÃO DOS RESULTADOS", startRow = 1, startCol = 1)

# Q1 e Q2
writeData(wb, "Verificacao", "Q1. Menor cotação", startRow = 3, startCol = 1)
writeData(wb, "Verificacao", "Fórmula MIN:", startRow = 3, startCol = 2)
writeFormula(wb, "Verificacao", "MIN(Serie_Historica!B:B)", startRow = 3, startCol = 3)

writeData(wb, "Verificacao", "Q2. Maior cotação", startRow = 4, startCol = 1)
writeData(wb, "Verificacao", "Fórmula MAX:", startRow = 4, startCol = 2)
writeFormula(wb, "Verificacao", "MAX(Serie_Historica!B:B)", startRow = 4, startCol = 3)

# Q3 - Variação mensal
writeData(wb, "Verificacao", "Q3. Variação média mensal", startRow = 6, startCol = 1)
writeData(wb, "Verificacao", "Fechamento mensal (último dia útil de cada mês):",
          startRow = 7, startCol = 1)

writeData(wb, "Verificacao",
          data.frame(Mes = verif_mensal$ano_mes,
                     Data = verif_mensal$data,
                     Preco = verif_mensal$preco),
          startRow = 8, startCol = 1)

n_meses <- nrow(verif_mensal)

# Coluna D: Variação mensal (%)
writeData(wb, "Verificacao", "Var. mensal (%)", startRow = 8, startCol = 4)
for (i in 2:n_meses) {
  r <- 8 + i
  writeFormula(wb, "Verificacao",
               paste0("(C", r, "/C", r - 1, "-1)*100"),
               startRow = r, startCol = 4)
}

# Média 2020 (meses 2 a 12 = fev a dez 2020, linhas 10 a 20 nas fórmulas)
# Mês 1 = jan/2020 (linha 9), mês 2 = fev/2020 (linha 10), ... mês 12 = dez/2020 (linha 20)
writeData(wb, "Verificacao", "Média mensal 2020:", startRow = 8 + n_meses + 2, startCol = 1)
writeFormula(wb, "Verificacao",
             paste0("AVERAGE(D10:D20)"),
             startRow = 8 + n_meses + 2, startCol = 2)

# Média 2024 (meses 49 a 60 = jan a dez 2024 no vetor; var de fev a dez)
# jan/2024 está no índice 49 da lista (linha 57), fev/2024 = linha 58 ... dez/2024 = linha 68
writeData(wb, "Verificacao", "Média mensal 2024:", startRow = 8 + n_meses + 3, startCol = 1)
writeFormula(wb, "Verificacao",
             paste0("AVERAGE(D58:D68)"),
             startRow = 8 + n_meses + 3, startCol = 2)

# Q4 - Variação acumulada
writeData(wb, "Verificacao", "Q4. Variação acumulada", startRow = 8 + n_meses + 5, startCol = 1)
writeData(wb, "Verificacao", "Primeiro preço (02/01/2020):",
          startRow = 8 + n_meses + 6, startCol = 1)
writeFormula(wb, "Verificacao", "Serie_Historica!B2",
             startRow = 8 + n_meses + 6, startCol = 2)

writeData(wb, "Verificacao", "Último preço:",
          startRow = 8 + n_meses + 7, startCol = 1)
n_serie <- nrow(serie)
writeFormula(wb, "Verificacao",
             paste0("Serie_Historica!B", n_serie + 1),
             startRow = 8 + n_meses + 7, startCol = 2)

r_acum <- 8 + n_meses + 8
writeData(wb, "Verificacao", "Variação acumulada (%):",
          startRow = r_acum, startCol = 1)
writeFormula(wb, "Verificacao",
             paste0("(B", r_acum - 1, "/B", r_acum - 2, "-1)*100"),
             startRow = r_acum, startCol = 2)

saveWorkbook(wb, "output/cobre_verificacao.xlsx", overwrite = TRUE)
```

Para permitir a conferência independente dos resultados obtidos via R, foi gerada
a planilha `output/cobre_verificacao.xlsx` com fórmulas nativas do Excel. Dessa
forma, cada resposta pode ser validada diretamente na planilha, sem depender da
execução do código.

- **Serie_Historica**: série completa de `r nrow(serie)` dias úteis.
- **Verificacao**: fórmulas `MIN`, `MAX`, `AVERAGE` e variações percentuais para
  conferir os resultados Q1 a Q4 e as variações mensais de 2020 e 2024.


# Anexo — Código completo {.unnumbered}

<details>
<summary><strong>Clique para expandir o código R completo</strong></summary>

```{r codigo_completo, eval=FALSE, echo=TRUE, code=readLines("analise_cobre_lme.Rmd")}
```

</details>
